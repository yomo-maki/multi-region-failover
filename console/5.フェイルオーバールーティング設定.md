# フェイルオーバールーティング構築
### 2つのリージョンにそれぞれ同じ構成を作成し、片方のリージョンで障害発生時にもう片方に待機させていたリージョンへとルーティングが切り替わることを確認します。

### 事前に準備するもの
- 2つのリージョンに同じような構成を作成してください。  
└前工程で作成したVPC～EC2起動までを別リージョンで実施します。  
[1. VPC構築](console/1.VPC構築.md) ＞ [2. EC2起動](console/2.EC2起動.md) ＞[3. EC2接続](console/3.EC2接続.md)  までを  
事前に大阪リージョンと東京リージョンにて以下のように作成（東京は前工程までで作成のため大阪を別途準備↓）
  <img src="images\fail-1.png">

- 自前で調達した外部ドメインの「ネームサーバー設定」にRoute53のNSレコードを登録しておく必要が有ります。
  - Route53ホストゾーンの以下画像箇所になります。
  <img src="images\fail-5.png">
  - ドメイン調達先の「ネームサーバー設定」にNSレコードを設定
  <img src="images\fail-6.png">

### 作成するもの
- Route53ヘルスチェック
- Route53 フェイルオーバールーティング

<br>
<br>

# 手順  

### 1. Route53ヘルスチェック作成  
  コンソールからRoute 53＞ヘルスチェック作成から、以下のように設定しRoute 53 ヘルスチェックを作成する。

  ```
    ヘルスチェックの環境設定
    ・名前：｛任意｝
    ・モニタリングの対象：エンドポイント
    エンドポイントの監視
    ・エンドポイントの指定：IPアドレス
    ・IPアドレス：プライマリリージョンのEIP
    その他はデフォルト
  ```

### 2. Route53 フェイルオーバールーティング作成  
  1. 前手順の「4.Route53 ホストゾーン構築」で作成した「ホストゾーン名」をクリックする。
  <img src="images\host-1.png">

  2. 遷移した画面から「レコードを作成」をクリック。
  以下のように設定しレコードを作成する。

  ```
    プライマリレコード
    ・レコード名：{任意}　今回はルートドメインを使いたいので空白にします。
    ・レコードタイプ：A -IPv4アドレスと一部のAWSリソースにトラフィックをルーティングします。
    ・値：プライマリリージョンの「2.EC2起動」で割り当てたEIP
    ・ルーティングポリシー：フェイルオーバー
    ・フェイルオーバレコードタイプ：プライマリ
    ・ヘルスチェックID：「1. Route53ヘルスチェック作成」で作成したヘルスチェック
    その他はデフォルト
  ```
  下部に「別のレコードを追加」とあるのでクリックし以下を設定。
  ```
    セカンダリレコード
    ・レコード名：{任意}　プライマリと合わせます。
    ・レコードタイプ：A -IPv4アドレスと一部のAWSリソースにトラフィックをルーティングします。
    ・値：セカンダリリージョンの「2.EC2起動」で割り当てたEIP
    ・ルーティングポリシー：フェイルオーバー
    ・フェイルオーバレコードタイプ：セカンダリ
    その他はデフォルト
  ```


  3. レコード作成後、アクセスして確認します。
     http://｛ルードドメイン｝/demo.html
    <img src="images\fail-2.png">
    プライマリリージョンの大阪のEC2へアクセスされました。

  4. フェイルオーバーからのルーティングを確認する。
    プライマリリージョンのEC2を停止させます。
    <img src="images\fail-3.png">
    EC2停止後、再度アクセスすると以下のようになります。
    <img src="images\fail-4.png">
    東京リージョンのEC2にアクセスが切り替わりました。

### 以上でRoute53フェイルオーバールーティング設定は完了となります。
